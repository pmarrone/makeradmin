FROM ubuntu:latest

ENV COMPOSER_ALLOW_SUPERUSER=1

# Download and install composer
# Note: netcat is required by the wait-for script
RUN    export DEBIAN_FRONTEND=noninteractive; \
       ln -sf /usr/share/zoneinfo/Europe/Stockholm /etc/localtime; \
       apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates curl netcat nano less nginx git unzip \
       php7.2-fpm php7.2-curl php7.2-mbstring php7.2-gd php7.2-json php7.2-mysql php7.2-opcache php7.2-intl php7.2-xml php-memcached\
    && rm -r /var/lib/apt/lists/* \
    && curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
    && mkdir -p /run/php \
    && ln -s /usr/sbin/php-fpm7.2 /usr/sbin/php-fpm

# Add and install common dependencies
ADD ./lumen/composer.json /var/www/html/
ADD ./lumen/composer.lock /var/www/html/
RUN composer install --no-scripts --no-autoloader --no-suggest --no-dev -d /var/www/html

# Webserver configuration files
ADD ./docker/nginx.conf /etc/nginx/nginx.conf
ADD ./docker/php-fpm-www.conf /etc/php/7.2/fpm/pool.d/www.conf

ADD ./docker/wait-for /usr/local/myscripts/
