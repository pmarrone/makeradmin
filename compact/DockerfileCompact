FROM ubuntu:latest

ENV COMPOSER_ALLOW_SUPERUSER=1

# Download and install major packages
# Note: netcat is required by the wait-for script
RUN    export DEBIAN_FRONTEND=noninteractive; \				
       ln -sf /usr/share/zoneinfo/Europe/Stockholm /etc/localtime; \
       apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates curl netcat iproute2 iputils-ping nano less nginx git unzip nodejs gnupg gnupg2 gnupg1 \
       php7.2-fpm php7.2-curl php7.2-mbstring php7.2-gd php7.2-json php7.2-mysql php7.2-opcache php7.2-intl php7.2-xml php-memcached python3 python3-pip \
       vim \
    && rm -r /var/lib/apt/lists/* \
    && curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
    && mkdir -p /run/php \
    && ln -s /usr/sbin/php-fpm7.2 /usr/sbin/php-fpm

ENV TZ Europe/Stockholm

# Nodesource cert etc
RUN curl -sL https://deb.nodesource.com/setup_8.x | bash -

# js dependencies
RUN export DEBIAN_FRONTEND=noninteractive; \
    apt-get install -y --no-install-recommends nodejs

# Python dependencies
WORKDIR /
RUN pip3 install --upgrade pip
RUN pip3 install setuptools
COPY ./servicebase_python/requirements.txt /
RUN pip3 install -r /requirements.txt

# Php dependencies
# Relying on library's composer-files being a superset of other php modules 

# top scripts
WORKDIR /
COPY ./compact/develStartupScript.sh /scripts/

# common log volume
VOLUME /var/www/html/storage/logs

EXPOSE 80

CMD ["/scripts/develStartupScript.sh"]

